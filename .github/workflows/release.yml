name: Release

on:
    push:
        tags:
            - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            # test - start
            # setup bun - start
            - name: Checkout
              uses: actions/checkout@v5

            - uses: oven-sh/setup-bun@v1

            - uses: actions/cache@v4
              name: Setup bun cache
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-store-${{ hashFiles('**/bun.lockb') }}

            - name: Install dependencies
              run: bun install --production --frozen-lockfile
            # setup bun - end

            - name: Check types
              run: bun run tsc
            # test - end

            # build - start
            - name: Build
              run: bun run build
            # build - end

            # transfer dist files - start
            - name: Transfer dist files to VM
              uses: appleboy/scp-action@v1.0.0
              with:
                  host: ${{ secrets.YA_CLOUD_PROD_HOST }}
                  username: ${{ secrets.YA_CLOUD_PROD_USERNAME }}
                  key: ${{ secrets.YA_CLOUD_PROD_KEY }}
                  port: ${{ secrets.YA_CLOUD_PROD_PORT }}
                  source: 'dist/*'
                  target: '~/my-server-nginx/dubna-hirudo-dist/'
                  strip_components: 1
                  overwrite: true
            # transfer dist files - end
